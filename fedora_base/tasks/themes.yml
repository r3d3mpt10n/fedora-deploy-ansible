---
- name: Clone git repos  # noqa git-latest
  ansible.builtin.git:
    repo: "{{ item.value.repo }}"
    dest: "{{ item.value.destination }}"
    depth: "{{ item.value.depth | default(omit) }}"
  loop: "{{ lookup('dict', base_git_repos) }}"
  async: "{{ ansible_check_mode | ternary(0, 700) }}"
  poll: "{{ ansible_check_mode | ternary(0, 10) }}"

- name: Copy wallpaper
  ansible.builtin.copy:
    remote_src: true
    src: "/home/{{ ansible_user }}/{{ base_pics_dir }}/{{ base_wp }}"
    dest: "/home/{{ ansible_user }}/{{ gnome_wp_dir }}/{{ base_wp }}"
    mode: u=rw,g=r,o=r

- name: Set wallpaper permission
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/.local/share/backgrounds/*"
    mode: u=rw,g=r,o=r
    recurse: true

- name: Set wallpaper
  community.general.dconf:
    key: "/org/gnome/desktop/background/picture-uri-dark"
    value: "'file:///home/{{ ansible_user }}/{{ gnome_wp_dir }}/truchet-d.jpg'"

- name: Check if theme dir already exists
  ansible.builtin.stat:
    path: "/home/{{ ansible_user }}/.themes/DraculaSur-gtk-theme"
  register: theme_dir_exists

- name: Download, extract and install theme
  when: theme_dir_exists.stat.exists == false
  block:
    - name: Download theme
      ansible.builtin.get_url:
        url: "https://github.com/Aryan20/DraculaSur-gtk-theme/archive/master.zip"
        dest: /tmp/
      register: theme_get_result

    - name: Extract it
      ansible.builtin.unarchive:
        remote_src: true
        src: "{{ theme_get_result.dest }}"
        dest: "/home/{{ ansible_user }}/.themes/DraculaSur-gtk-theme"

    - name: Cleanup
      ansible.builtin.file:
        path: "/tmp/DraculaSur-gtk-theme-master.zip"
        state: absent

- name: Configure fonts
  tags: notest
  block:
    - name: Make fonts directory
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/"
        state: directory
        mode: u=rw,g=rw,o=r

    - name: Collect fonts
      ansible.builtin.get_url:
        url: "https://github.com/ryanoasis/nerd-fonts/releases/download/v2.1.0/Hack.zip"
        dest: "/home/{{ ansible_user }}/.local/share/fonts/"
      register: fonts_get_result

    - name: Extract fonts
      ansible.builtin.unarchive:
        remote_src: true
        src: "{{ fonts_get_result.dest }}"
        dest: "/home/{{ ansible_user }}/.local/share/fonts/"

- name: Set the theme
  community.general.dconf:
    key: "/org/gnome/desktop/interface/{{ item.key }}"
    value: "'{{ item.value }}'"
  loop: "{{ base_gnome_settings | dict2items }}"
